#!/bin/sh
# 
# tintyourday - generate your tint2 config with Xresources color
#
# Copyright (c) 2018 Yasushi Nanda Vera. 
# Licensed under MIT License, See LICENSE.md for more information

USERPRESETDIR="$(readlink -f $(dirname "$0"))"
PRESETDIR="/usr/share/tintyourday"
TINT2DIR="$HOME/.config/tint2"

cathelp(){
cat <<EOF
Usage: tintyourday -p [preset-name]
tintyourday - generate your tint2 config with Xresources color
     -p, --preset [preset-name]    use preset from preset directory
     -r, --replace                 replace currently used config with generated theme
 
Preset are located in:
    /usr/share/tintyourday/[presetname].conf
    /home/$USER/.config/tintyourday/[presetname].conf
You can see the default preset in /usr/share/tintyourday/default.conf.
Preset are basically same as tint2rc configuration, but you can use Xresources color as references.
Example :
    background_color = \$(xres bg) 100
    taskbar_name_font_color = \$(xres fg) 100
EOF
}

while [[ $# > 0 ]]
do
    key="$1"
    while [[ ${key+x} ]]
    do
        case $key in
            -p*|--preset)
                PRESET="$2"
                shift
                ;;
            -r*|--replace)
                REPLACE="true"
                shift
                ;;
            *)
                cathelp
                exit 10
                break
                ;;
        esac
        [[ "$key" = -? || "$key" == --* ]] && unset key || key="${key/#-?/-}"
    done
    shift
done

xres() {
    case $1 in 
        fg)
            xrdb -query | egrep -m1 "^\*\.?foreground:" | awk '{print $NF}' 
        ;;
        bg)
            xrdb -query | egrep -m1 "^\*\.?background:" | awk '{print $NF}' 
        ;;
        *) 
            xrdb -query | egrep -m1 "^\*\.?color$1:" | awk '{print $NF}'
        ;;
    esac
}

checkfile() {
    if [[ -f "$USERPRESETDIR/$1.conf" ]]
    then
        echo "Preset $PRESET found.  Generating..."
        PRESETFILE=$USERPRESETDIR/$1.conf
    elif [[ -f "$PRESETDIR/$1.conf" ]]
    then
        echo "Preset $PRESET found.  Generating..."
        PRESETFILE=$PRESETDIR/$1.conf
    else
        echo "Preset $1 not found.  Exiting."
        exit 10
    fi
}

generate() {

    echo "# generated by tintyourday"

    cat "$PRESETFILE" | while read line
    do
        if [[ "$(echo $line | grep 'xres')" ]]
        then
            eval echo ${line}
        else
            echo ${line}
        fi
    done 
}

if [[ -z "$PRESET" ]]
then
    echo "No Preset.  Generate from default preset."
    PRESET=default
fi
checkfile $PRESET
generate $PRESET > $PRESET-preset.tintrc
echo $PRESET > $HOME/.cache/.tintyesterday

if [[ -n "$REPLACE" ]]
then
    mv $TINT2DIR/tint2rc $TINT2DIR/tint2rc.bak
    cp -f $PRESET-preset.tintrc $TINT2DIR/tint2rc
    pkill -USR1 -x tint2
fi

echo "Complete. Saved as $PRESET-preset.tintrc."
